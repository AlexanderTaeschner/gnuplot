#
# $Id: makefile.nt,v 1.10 2002/03/26 17:03:53 broeker Exp $
#
# GNUPLOT Makefile Microsoft Visual C++ and nmake on WinNT and Win95/98/..

#
# To compile gnuplot, run the following command in directory gnuplot\src:
#	nmake -f ..\config\makefile.nt
#

# John Bollinger bbands@yahoo.com
# 4 March 2002 bbands@yahoo.com
# Added png support with zlib and libpng as subs of .\src
# libpng and zlib can be downloaded from ftp://ftp.uu.net/graphics/png
# Added pdf support with pdflib as a sub of .\src
# pdflib can be downloaded from http://www.pdflib.com
# Added MSC multi-thread support for compatibility with pdflib
# To compile with Visual C: 
#	Download zlib to ..\src\zlib and compile it 
#	Copy zlib.dll to \winnt\system32 or anywhere else in the path
#	Download libpng to ..\src\libpng and compile it
#	Download pdflib to ..\src\pdflib and compile it if you choose the source
#	Copy ..\config\config.nt to ..\src\config.h
#	Find and run VCVARS32.BAT
#	Then from ..\src nmake -f ..\config\makefile.nt
#
# 15 February 2003: Added support for compiling pgnuplot
#                   Cleaned up clean and veryclean

# where to place gnuplot.gih helpfile
HELPFILE = wgnuplot.hlp

TOP = .

# /c  means don't link
# /I  means extra include directory
# /Fm means produce link map
# /Od means suppress optimizations (esp. for debug)
# /O2 mans optimize for speed
# /Zi mean prepare for codeview
# /G6 means optimize code for pentium pro
# /G5 means optimize code for pentium
# /G4 means optimize code for 486
# /G3 means optimize code for 386
# /MT means include multi-thread support

CC = cl /c
LD = link

# compiler flags
CFLAGS = /G5 /O2 /MT /I$(TOP) /nologo /D_Windows /DHAVE_CONFIG_H /D__MSC__ /DUSE_MOUSE /DPM3D /DHELPFILE=\"$(HELPFILE)\" /DHAVE_LIBPNG /DHAVE_LIBPDF

!IF "$(PROCESSOR_ARCHITECTURE)" == "ALPHA"
MACHINE = $(PROCESSOR_ARCHITECTURE)
!ELSE
MACHINE = IX86
!ENDIF

# paths for external libs added here... 
# /NODEFAULTLIBs to avoid MSC multi-thread conflicts 
LDFLAGS = /subsystem:windows /nologo /MACHINE:$(MACHINE) /MAP:GNUPLOT /libpath:..\src\zlib /libpath:..\src\libpng /libpath:..\src\pdflib\pdflib /NODEFAULTLIB:LIBC.lib /NODEFAULTLIB:LIBCMTD.lib 

# ...and here.
# see other terminal defines in term.h
TERMFLAGS = /I..\\term /I..\\src\\libpng /I..\\src\\zlib /I..\\src\\pdflib\\pdflib

# macros for makefile.all
O=obj
T=..\\term\\
D=..\\docs\\
M=..\\demo\\

default: wgnuplot.exe $(HELPFILE) wgnuplot.mnu $(M)bf_test.exe pgnuplot.exe

!INCLUDE makefile.all

OBJS = $(COREOBJS) version.obj

WINOBJS = winmain.obj wgnuplib.obj wgraph.obj wprinter.obj wtext.obj \
	wpause.obj wmenu.obj gpexecute.obj

WINDOWS = makefile.win makefile.nt README.win win\wcommon.h \
	win\wgnuplib.c win\wgnuplib.def win\wgnuplib.h win\wgnuplib.rc \
	win\wgnuplot.def win\wgnuplot.hpj win\wgnuplot.mnu win\wgraph.c \
	win\winmain.c win\wmenu.c win\wpause.c win\wprinter.c \
	win\wresourc.h win\wtext.c win\wtext.h win\geticon.c \
	$(D)doc2rtf.c $(T)win.trm win\grpicon.ico win\texticon.ico

# default rules
.c.obj:
	$(CC) $(CFLAGS) $*.c

linkopt1.msw: makefile.nt
	copy gnuplot.opt linkopt1.msw
	echo winmain >> linkopt1.msw
	echo gpexecute >> linkopt1.msw
	echo readline >> linkopt1.msw
	echo wgnuplib >> linkopt1.msw
	echo wtext >> linkopt1.msw
	echo wmenu >> linkopt1.msw
	echo wpause >> linkopt1.msw
	echo wgraph >> linkopt1.msw
	echo wprinter >> linkopt1.msw
	echo kernel32.lib >> linkopt1.msw
	echo user32.lib >> linkopt1.msw
	echo gdi32.lib >> linkopt1.msw
	echo winspool.lib >> linkopt1.msw
	echo comdlg32.lib >> linkopt1.msw
	echo advapi32.lib >> linkopt1.msw
	echo shell32.lib >> linkopt1.msw
	echo pdflib.lib >> linkopt1.msw
	echo libpng.lib >> linkopt1.msw
	echo zlib.lib >> linkopt1.msw
	echo wgnuplot.res >> linkopt1.msw

wgnuplot.exe: $(OBJS) $(WINOBJS) win\wgnuplot.def wgnuplot.res linkopt1.msw texticon.ico grpicon.ico
	$(LD) $(LDFLAGS) /out:wgnuplot.exe @linkopt1.msw

# rules

wgnuplot.res :  win\wgnuplot.rc win\wgnuplib.rc win\wresourc.h texticon.ico grpicon.ico
	rc /l 0x409 /fowgnuplot.res /i "win" /d "NDEBUG" /d WIN32 /d MSRC win\wgnuplot.rc

term.obj: term.c term.h plot.h setshow.h bitmap.h $(CORETERM)
	$(CC) $(CFLAGS) $(TERMFLAGS) term.c

winmain.obj: win\winmain.c win\wgnuplib.h win\wtext.h plot.h
	$(CC) $(CFLAGS) /DHELPFILE=\"$(HELPFILE)\"  win\winmain.c

WINDEPS = win\wgnuplib.h win\wcommon.h win\wresourc.h

wgnuplib.obj: win\wgnuplib.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wgnuplib.c

wmenu.obj: win\wmenu.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wmenu.c

wtext.obj: win\wtext.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wtext.c

wpause.obj: win\wpause.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wpause.c

wprinter.obj: win\wprinter.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wprinter.c

wgraph.obj: win\wgraph.c $(WINDEPS)
	$(CC) $(CFLAGS) win\wgraph.c

wgnuplot.mnu: win\wgnuplot.mnu
	copy win\wgnuplot.mnu wgnuplot.mnu

pgnuplot.exe: win\pgnuplot.c
	cl /nologo /O2 win\pgnuplot.c /I. /link /NODEFAULTLIB:LIBC.lib version.obj user32.lib

# extract icons from wgnuplot.rc
texticon.ico: grpicon.ico

grpicon.ico: geticon.exe win\wgnuplot.rc
	geticon win\wgnuplot.rc

geticon.exe: win\geticon.c
	cl /DMSDOS /F 5000 /W1 win\geticon.c

# convert gnuplot.doc to gnuplot.rtf
$(HELPFILE): doc2rtf.exe $(D)gnuplot.doc win\wgnuplot.hpj
	doc2rtf $(D)gnuplot.doc win\gnuplot.rtf
	hcw /c /e win\wgnuplot.hpj
	if exist win\wgnuplot.hlp copy win\wgnuplot.hlp .

doc2rtf.exe: $(D)doc2rtf.c $(D)termdoc.c $(D)xref.c
	cl $(CFLAGS) /F 5000 /W1 /I. /DWINDOWS_NO_GUI /I$(D) /I$(T) -Fedoc2rtf.exe $(D)doc2rtf.c $(D)termdoc.c $(D)xref.c

#make binary demo files
$(M)bf_test.exe : bf_test.c dbinary.obj alloc.obj
		cl $(CFLAGS) /F 5000 /W1 /DWINDOWS_NO_GUI /Fe$(M)bf_test.exe bf_test.c dbinary.obj alloc.obj
	cd ..\demo
	bf_test
	cd ..\src

# _Windows causes wtext.h to define fread() etc
dbinary.obj: binary.c
		$(CC) $(CFLAGS) /U_Windows /F 5000 /W1 /Fodbinary.obj binary.c

# clean up temporary files
clean:
	if exist *.obj del *.obj
	if exist *.ico del *.ico
	if exist wgnuplot.res del wgnuplot.res
	if exist win\gnuplot.rtf del win\gnuplot.rtf
	if exist win\wgnuplot.hlp del win\wgnuplot.hlp
	if exist ..\demo\bf_test.exe del ..\demo\bf_test.exe
	if exist linkopt1.msw del linkopt1.msw
	if exist doc2rtf.exe del doc2rtf.exe
	if exist geticon.exe del geticon.exe
	if exist GNUPLOT del GNUPLOT

veryclean: clean
	if exist wgnuplot.exe del wgnuplot.exe
	if exist wgnuplot.hlp del wgnuplot.hlp
	if exist wgnuplot.mnu del wgnuplot.mnu
	if exist pgnuplot.exe del pgnuplot.exe
	if exist ..\demo\binary1 del ..\demo\binary1
	if exist ..\demo\binary2 del ..\demo\binary2
	if exist ..\demo\binary3 del ..\demo\binary3
	if exist ..\demo\fit.log del ..\demo\fit.log
	if exist ..\demo\soundfit.par del ..\demo\soundfit.par
	if exist config.h del config.h
	if exist makefile.nt del makefile.nt
